<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>災害時ペット状況マップ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { margin:0; font-family: system-ui, -apple-system, "Noto Sans JP", sans-serif; }
    #map { height: 100vh; width: 100%; background:#e5e7eb; }
    #panel{
      position:absolute; top:10px; left:10px; z-index:1000;
      background:#fff; padding:10px 12px; border-radius:12px;
      box-shadow:0 2px 10px rgba(0,0,0,.15);
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      max-width: calc(100% - 20px);
    }
    select, button{ font-size:13px; padding:8px 10px; border-radius:10px; border:1px solid #ddd; background:#fff; }
    button{ cursor:pointer; }
    #status{ font-size:12px; }
    #debug{ font-size:11px; color:#6b7280; max-width: 100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .err{ color:#b91c1c; }
  </style>
</head>
<body>
  <div id="panel">
    <select id="fUrgency">
      <option value="">緊急度：すべて</option>
      <option value="高">高</option>
      <option value="中">中</option>
      <option value="低">低</option>
    </select>

    <select id="fBuilding">
      <option value="">建物：すべて</option>
      <option value="安全">安全</option>
      <option value="一部損壊">一部損壊</option>
      <option value="倒壊">倒壊</option>
      <option value="不明">不明</option>
    </select>

    <select id="fPet">
      <option value="">ペット：すべて</option>
      <option value="無事">無事</option>
      <option value="ケガ">ケガ</option>
      <option value="行方不明">行方不明</option>
      <option value="一時的な預け先あり">一時的な預け先あり</option>
    </select>

    <button id="reload">更新</button>
    <span id="status">初期化中…</span>
    <span id="debug"></span>
  </div>

  <div id="map"></div>

<script>
/**
 * ✅ここにGASのWebアプリURL（/exec）を入れる
 * 例：https://script.google.com/macros/s/AKfycbxxxxxxx/exec
 */
const GAS_API_BASE = "https://script.google.com/macros/s/AKfycbwtsh0c-zNwpa2hnzGKJyEnzweV9MKxalndWds2e7gJtMri-yrnc9NbkRO-OL7gabHd/exec?api=reports&limit=500";

let map, layer;
let markers = [];

function setStatus(msg, ok=true){
  const el = document.getElementById('status');
  el.textContent = msg;
  el.className = ok ? '' : 'err';
}
function setDebug(msg){
  document.getElementById('debug').textContent = msg || '';
}

function colorByUrgency(u){
  if (!u) return '#2563eb';
  u = String(u);
  if (u.startsWith('高')) return '#dc2626';
  if (u.startsWith('中')) return '#f59e0b';
  if (u.startsWith('低')) return '#16a34a';
  return '#2563eb';
}
function dotIcon(color){
  return L.divIcon({
    className:'',
    html:`<div style="width:14px;height:14px;border-radius:50%;background:${color};border:2px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,.35)"></div>`,
    iconSize:[14,14],
    iconAnchor:[7,7]
  });
}
function esc(s){
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}
function popupHtml(r){
  const ts = r.timestamp ? new Date(r.timestamp).toLocaleString() : '';
  const gmap = `https://www.google.com/maps?q=${r.lat},${r.lng}`;
  return `
    <div style="font-size:13px;line-height:1.45;">
      <b>${esc(ts)}</b><br>
      ${r.urgency ? `緊急度：<b>${esc(r.urgency)}</b><br>` : ''}
      ${r.building ? `建物：${esc(r.building)}<br>` : ''}
      ${r.pet_status ? `ペット：${esc(r.pet_status)}<br>` : ''}
      ${r.location_text ? `住所/目印：${esc(r.location_text)}<br>` : ''}
      ${r.supplies ? `物資：${esc(r.supplies)}<br>` : ''}
      <a href="${gmap}" target="_blank" rel="noopener">Googleマップで開く</a>
      ${r.photo_url ? `<br><a href="${r.photo_url}" target="_blank" rel="noopener">写真を開く</a>` : ''}
      ${r.comment ? `<div style="margin-top:6px;white-space:pre-wrap;">${esc(r.comment)}</div>` : ''}
    </div>
  `;
}

function applyFilters(rows){
  const u = document.getElementById('fUrgency').value;
  const b = document.getElementById('fBuilding').value;
  const p = document.getElementById('fPet').value;

  return (rows||[]).filter(r=>{
    if (u && !(String(r.urgency||'').startsWith(u))) return false;
    if (b && String(r.building||'') !== b) return false;
    if (p && String(r.pet_status||'') !== p) return false;
    return true;
  });
}

/**
 * JSONPでGAS APIを読む
 */
function fetchReportsJsonp(){
  return new Promise((resolve, reject)=>{
    const cbName = 'cb_' + Math.random().toString(36).slice(2);
    const url = `${GAS_API_BASE}&callback=${cbName}`;

    const timer = setTimeout(()=>{
      cleanup();
      reject(new Error('timeout'));
    }, 10000);

    function cleanup(){
      clearTimeout(timer);
      delete window[cbName];
      script.remove();
    }

    window[cbName] = (payload)=>{
      cleanup();
      resolve(payload);
    };

    const script = document.createElement('script');
    script.src = url;
    script.onerror = ()=>{
      cleanup();
      reject(new Error('JSONP load error'));
    };
    document.head.appendChild(script);
  });
}

async function reload(){
  setStatus('読み込み中…', true);
  try{
    const payload = await fetchReportsJsonp(500);
    const rows = payload && Array.isArray(payload.rows) ? payload.rows : [];
    setDebug(`debug: ${payload && payload.debug ? JSON.stringify(payload.debug).slice(0,120) : '(no debug)'} / rows=${rows.length}`);

    // 描画
    layer.clearLayers();
    const filtered = applyFilters(rows);

    if (filtered.length === 0){
      setStatus('該当データがありません。', true);
      return;
    }

    const bounds = [];
    filtered.forEach(r=>{
      const lat = Number(r.lat), lng = Number(r.lng);
      if (!isFinite(lat) || !isFinite(lng)) return;

      const m = L.marker([lat,lng], {icon: dotIcon(colorByUrgency(r.urgency))}).bindPopup(popupHtml(r));
      m.addTo(layer);
      bounds.push([lat,lng]);
    });

    setStatus(`表示件数：${filtered.length}件`, true);
    if (bounds.length) map.fitBounds(bounds, {padding:[30,30]});

  }catch(err){
    setStatus('取得エラー', false);
    setDebug(String(err && err.message ? err.message : err));
  }
}

document.addEventListener('DOMContentLoaded', ()=>{
  map = L.map('map').setView([35.6812, 139.7671], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19}).addTo(map);
  layer = L.layerGroup().addTo(map);

  document.getElementById('reload').addEventListener('click', reload);
  ['fUrgency','fBuilding','fPet'].forEach(id => document.getElementById(id).addEventListener('change', reload));

  reload();
});
</script>
</body>
</html>
